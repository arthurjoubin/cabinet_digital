{% load custom_filters %}

{% if software %}
<a href="{% url 'software_detail' software.slug %}" class="block no-underline text-inherit">
  <article class="bg-white border border-gray-300 rounded-md overflow-hidden transition-all duration-300 hover:shadow-lg hover:bg-sky-50 p-2 h-full flex flex-col relative group cursor-pointer">
    {% if software.is_top_pick %}
    <div class="absolute top-2 right-2">
      <div class="bg-black text-white px-2 py-1 text-xs font-medium rounded-md">
          Recommand√©
      </div>
    </div>
    {% endif %}

    <header class="flex flex-col items-center mb-3">
        {% if software.logo %}
        <div class="w-14 h-14 flex items-center justify-center mb-3">
            <img loading="lazy" width="56" height="56" src="{{ software.logo.url }}" alt="{{ software.name }}" class="max-w-full max-h-full object-contain">
        </div>
        {% else %}
        <div class="w-14 h-14 flex items-center justify-center mb-3 bg-gray-50 rounded-full border border-gray-200">
            <svg class="w-7 h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        </div>
        {% endif %}
        <h3 id="title" class="text-xl font-bold text-gray-900 text-center mb-1.5">{{ software.name }}</h3>
        
        <p class="text-sm text-gray-500 text-center leading-normal max-w-xs line-clamp-2">{{ software.excerpt|safe|truncatechars:80 }}</p>
        
        {% if software.published_reviews.exists %}
        <div class="flex items-center justify-center mt-2">
            {% include "partials/star_rating.html" with rating=software.published_average_rating size=4 %}
            <span class="ml-1.5 text-xs text-gray-600">{{ software.published_average_rating|floatformat:1 }}
                <span class="text-gray-500">({{ software.published_reviews.count }})</span>
            </span>
        </div>
        {% endif %}
    </header>

    {% with published_categories=software.category.all|published_only %}
    {% if published_categories %}
    <div id="categs" class="flex flex-wrap gap-1 justify-center mb-3" x-data="{ showAllTags: false }">
        {% for category in published_categories|dictsort:"name" %}
        <a href="{% url 'category_detail' category.slug %}" class="inline-flex items-center px-1.5 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded-md border border-gray-200 hover:bg-gray-200 transition-colors duration-200" 
           x-show="$el.dataset.index < 2 || showAllTags" 
           data-index="{{ forloop.counter0 }}"
           onclick="event.stopPropagation()">
            {% if category.icon %}
                <img src="{{ category.icon.url }}" alt="{{ category.name }}" class="w-3 h-3 mr-1">
            {% endif %}
            {{ category.name }}
        </a>
        {% endfor %}
        {% if published_categories.count > 2 %}
        <button @click="showAllTags = !showAllTags; $event.stopPropagation()" 
                class="inline-flex items-center px-1 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-md border border-blue-200 hover:bg-blue-200 transition-colors duration-200">
            <span x-text="showAllTags ? 'Voir moins' : '+{{ published_categories.count|add:'-2' }}'"></span>
        </button>
        {% endif %}
    </div>
    {% endif %}
    {% endwith %}
  </article>
</a>
{% endif %}